<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SlaRle Demo</title>
    
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
      video {
        display: none;
      }
      canvas { 
        margin-top: 10px;
        width: 100%; border: 1px solid #DDD; background: #FAFAFA; cursor: pointer; 
      }
      input[type=file] { 
        display: none; 
      }
    </style>
    
  </head>
  
  <body>
    <div class="container">
      <div class="row">
        <div class="col-xs-10 col-xs-offset-1 col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4">
        
          <div class="row">
            <div class="col-xs-12">
              <h2>SlaRle.js Demo</h2>
            </div>
          </div>
          
          <div class="row">
            <div class="col-xs-12">
              <h3>Result: <span id="result">-</span></h3>
            </div>
          </div>
          
          <div class="row">
            <div class="col-xs-12">
              <h4>Time: <span id="time">0</span> s</h4>
            </div>
          </div>
          
          <div class="row">
            <div class="col-xs-12">
              <div class="input-group">
                <span class="input-group-addon">Max. Res</span>
                <select id="resolution" class="form-control" >
                  <option value="400">400</option>
                  <option value="500">500</option>
                  <option value="600" selected>600</option>
                  <option value="800">800</option>
                  <option value="1000">1000</option>
                </select>
                <!-- <input id="resolution" type="text" class="form-control" value="640"> -->
                <span class="input-group-addon">px</span>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-xs-6 pull-right">
              <button id="scan" type="button" class="btn btn-success btn-lg btn-block">Scan</button>
            </div>
          </div>
                    
          <div class="row">
            <div class="col-xs-12">
              <canvas id="workCanvas">Canvas tag not supported</canvas>
              <video id="camera">Video tag not supported</video>
            </div>
          </div>
          
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    
    <script>

      const TimeKeeper = (function() {
        var startTime;

        return {
          start: function() {
            startTime = Date.now();
          },
          end: function() {
            return (Date.now() - startTime)
          }
        }
      })()

      //refs
      var $video = document.getElementById('camera');
      var $workCanvas = document.getElementById('workCanvas');
      var $resolution = document.getElementById('resolution');
      var $time = document.getElementById('time');
      var $result = document.getElementById('result');
      var $btnScan = document.getElementById('scan');

      var raf = null; //requestAnimationFrame handle
      var found = false;
      var wwReady = false;
      
      var SlaRleWorker = new Worker('./js/SlaRle.js');

      attachEvents();
      initCamera($video, startApp);

      function attachEvents() {
        $resolution.onchange = function(ev) {
          var width = $resolution.value;
          initCanvasSize(width, $video.videoWidth)
        }

        // scan initiated
        $btnScan.onclick = function() {
          found = false;
          if (raf === null) drawFrame(); //start drawing
          initResults();
          doScan();
        }

        SlaRleWorker.onmessage = handleWwMessage;
      }

      // var constraints = { 
      //   video: { 
      //     facingMode: ("environment") ,
      //     width: 600, 
      //     height: 800
      //   } 
      // };

      function initCamera($video, cb) {
        // create constraints for back camera from devices list
        function getBackCamConstraints(devices) {
          devices = devices.filter(function(d) {
            return d.kind === 'videoinput';
          });
          var back = devices.find(function(d) {
            return d.label.toLowerCase().indexOf('back') !== -1;
          }) || (devices.length && devices[devices.length - 1]);
          var constraints = {video: true}
          if (back) {
            constraints.video = {deviceId: back.deviceId};
            // constraints.video = {mandatory: {deviceId: back.deviceId}};
          }
          return constraints;
        }

        // initialize back camera
        navigator.mediaDevices.enumerateDevices()
        .then(function(devices) {
            var constraints = getBackCamConstraints(devices);
            return navigator.mediaDevices.getUserMedia(constraints);
        })
        .then(function(mediaStream) {
          $video.srcObject = mediaStream;
          $video.onloadedmetadata = function(e) {
            $video.play();
            cb();
          };
        })
        .catch(function(err) { 
          alert(err.name);
          console.log(err.name + ": " + err.message); 
        }); // always check for errors at the end.
      }

      function startApp() {
        initResults();
        initCanvasSize($resolution.value, Math.max($video.videoWidth, 600));
        drawFrame();
        doScan();
      }

      function showResults(result, timeMs) {
        $time.innerText = (timeMs / 1000);
        $result.innerText = result;
      }
      function initResults() {
        showResults('...', 0);
      }

      function doScan() {
        TimeKeeper.start();
        var tempCanvasCtx = $workCanvas.getContext("2d");
        var imgData = tempCanvasCtx.getImageData(0, 0, $workCanvas.width, $workCanvas.height);

        // prepare message
        var message = {
          imgData: imgData,
        };
        
        console.log('send')
        SlaRleWorker.postMessage(message);
        message = null;
      }

      function drawFrame() {
        if (wwReady) {
          var ctx = $workCanvas.getContext("2d");
          drawVideo($video, $workCanvas, ctx);
          drawLine($workCanvas, ctx);
        }
        // keep the cycle going
        raf = requestAnimationFrame(drawFrame);
      }

      function drawVideo($video, $canvas, ctx) {
        var dw = $canvas.width,
          dh = $canvas.height,
          sw = $video.videoWidth,
          sh = Math.ceil(dh / dw * sw)
          sy = Math.floor(($video.videoHeight - sh) / 2);

        // ctx.drawImage(video, 0, 0);
        ctx.drawImage($video, 0, sy, sw, sh, 0, 0, dw, dh);
      }

      function drawLine($canvas, ctx) {
        var dw = $canvas.width,
          dh = $canvas.height
        ctx.strokeStyle = 'rgba(255, 0, 0, 0.9)'
        ctx.beginPath();
        ctx.moveTo(dw*0.33, dh*0.5);
        ctx.lineTo(dw*0.67, dh*0.5);
        ctx.stroke();
      }

      function initCanvasSize(width, vidWidth) {
        var newWidth = Math.min(width, vidWidth);
        $workCanvas.width = newWidth;
        $workCanvas.height = Math.ceil(newWidth/2);
      }

      function handleDecodeResult(payload) {
        if (found) {
          return;
        }
        if (payload.EAN && payload.EAN.length > 0) {
          found = true;
          showResults(payload.EAN.toString(), TimeKeeper.end())

          //cancel next scan
          if (raf !== null) {
            cancelAnimationFrame(raf);
            raf = null;
          }
        } else {
          showResults('...', TimeKeeper.end())
          doScan();
        }
      }

      function handleStatusUpdate(payload) {
        if (payload.status === 'ready') {
          wwReady = true;
        }
      }

      // receive worker messages
      function handleWwMessage(e) {
        console.log('received', e.data.type)

        switch (e.data.type) {
          case 'decoding': 
            handleDecodeResult(e.data.payload);
            break;
          case 'status':
            handleStatusUpdate(e.data.payload);
            break;
          default:
            break;
        }
      }
      
    </script>
    
  </body>
</html>